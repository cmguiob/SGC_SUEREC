---
title: "CÃ¡lculo del factor de erodabilidad K con SoilGrids"
author: "Carlos M. GuÃ­o Blanco"
date: "2025-07-15"
format: html
editor:
  markdown:
    wrap: 80
---

Este cuaderno calcula el factor de erodabilidad del suelo **K** (en unidades
mÃ©tricas: tÂ·haâ»Â¹Â·hÂ·MJâ»Â¹Â·mmâ»Â¹) a partir de datos de textura, densidad aparente y
carbono orgÃ¡nico del suelo proporcionados por **SoilGrids**. Se implementan y
comparan dos fÃ³rmulas publicadas:

1. **Torri et al. (1997)**: basada en textura, materia orgÃ¡nica y densidad.
2. **Williams (1995)**: usada en el modelo EPIC/SWAT, basada en textura.

## 1. Carga de librerÃ­as y funciones

```{r setup}
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(
  here, sf, terra, dplyr, tidyr, ggplot2
)
```

## 2. Lectura del polÃ­gono de estudio y definiciÃ³n de CRS

```{r}
# Cargar polÃ­gono geojson
poli_estudio <- st_read(here("RUSLE_SoilGrids", "Data", "INP_cuenca_rio_barbas.geojson"))

# Transformar a CRS de SoilGrids (IGH: EPSG 54052)
wkt_igh <- "+proj=igh +lat_0=0 +lon_0=0 +datum=WGS84 +units=m +no_defs"
poli_estudio_igh <- st_transform(poli_estudio, wkt_igh)
```

## 3. Descarga y carga de capas de SoilGrids

```{r}
# Usamos funciÃ³n externa para descarga vÃ­a GDAL
source(here("RUSLE_SoilGrids", "Scripts", "00_funcion_descarga_soilgrids.R"))

stack_soil <- descargar_soilgrids_stack(
  vars = c("sand", "silt", "clay", "soc", "bdod"),
  depths = c("0-5cm"),
  stats = c("mean"),
  resolucion = c(250, 250),
  ruta_vrt = here("RUSLE_SoilGrids", "Data", "OUT_SoilGrids_vrt")
)

# Recorte al Ã¡rea de estudio
stack_soil_crop <- crop(stack_soil, vect(poli_estudio_igh)) |> 
  mask(vect(poli_estudio_igh))
```

## 4. ConversiÃ³n de unidades

```{r}
# Extraer y convertir unidades
sand <- stack_soil_crop[["sand_0-5cm_mean"]] / 10  # g/kg â†’ %
silt <- stack_soil_crop[["silt_0-5cm_mean"]] / 10
clay <- stack_soil_crop[["clay_0-5cm_mean"]] / 10
soc  <- stack_soil_crop[["soc_0-5cm_mean"]] / 10  # dg/kg â†’ %
bd   <- stack_soil_crop[["bdod_0-5cm_mean"]] / 100  # cg/cmÂ³ â†’ g/cmÂ³

# Materia orgÃ¡nica a partir de SOC
om <- soc * 1.724
```


## 1. EcuaciÃ³n de Renard et al. (1997) vÃ­a Dg (Eq. 3 en Anache et al. 2015)

Esta ecuaciÃ³n estima K a partir del **diÃ¡metro geomÃ©trico medio** (Dg) de las partÃ­culas, aplicando una funciÃ³n tipo gaussiana. Es adecuada para suelos donde se dispone de textura completa. Fue reportada por Renard et al. (1997) y utilizada por Bonilla & Johnson (2012) y Anache et al. (2015).

ğŸ“˜ Referencia: Renard et al. (1997) - [RUSLE Handbook](https://www.ars.usda.gov/ARSUserFiles/60600505/RUSLE/AH_703.pdf)

```{r}
# DiÃ¡metro medio de cada fracciÃ³n (Î¼m): arena=1000, limo=26, arcilla=1
log_dg <- (sand * log(1000) + silt * log(26) + clay * log(1)) / 100
dg <- exp(log_dg)

K_renard <- 0.0034 + 0.0405 * exp(-0.5 * ((log(dg) + 1.659) / 0.7101)^2)

writeRaster(K_renard, "Data/K_renard_dg.tif", overwrite = TRUE)
```

## 2. EcuaciÃ³n de Denardin (1990) (Eq. 5 en Anache et al. 2015)

Propone un cÃ¡lculo de K usando una combinaciÃ³n de variables texturales: fracciones finas y materia orgÃ¡nica. Es ampliamente utilizada en Brasil y recomendada para suelos tropicales. Se ha aplicado en estudios regionales con SoilGrids.

ğŸ“˜ Referencia: Denardin, J.E. (1990). *CompactaÃ§Ã£o do solo: causas e efeitos*. EMBRAPA.

```{r}
M <- (silt + sand) * (100 - clay)
K_denardin <- 0.0134 + 0.0027 * M / 10000 - 0.00001 * M^2 / 1e8

writeRaster(K_denardin, "Data/K_denardin.tif", overwrite = TRUE)
```

## 3. EcuaciÃ³n de Sharpley & Williams (1990) (Eq. 6 en Anache et al. 2015)

Usada originalmente en el modelo EPIC y luego adoptada en SWAT, esta ecuaciÃ³n permite estimar K usando arena, limo, arcilla y contenido de carbono. Es una de las mÃ¡s sÃ³lidas en tÃ©rminos estadÃ­sticos para regiones sin datos de estructura.

ğŸ“˜ Referencia: Sharpley, A.N. & Williams, J.R. (1990). *EPIC-Erosion Productivity Impact Calculator.* USDA Technical Bulletin No. 1768.

```{r}
# Subecuaciones segÃºn Anache et al. (2015), adaptadas de Sharpley & Williams
fcsand <- 0.2 + 0.3 * exp(-0.0256 * sand * (1 - silt / 100))
sl_clay <- silt / (clay + silt)
om_term <- 1 - 0.25 * OM / (OM + exp(3.72 - 2.95 * OM))
K_sw <- fcsand * sl_clay^0.3 * om_term

# ConversiÃ³n a unidades SI
K_sw_SI <- K_sw * 0.1317

writeRaster(K_sw_SI, "Data/K_sharpley_williams.tif", overwrite = TRUE)
```

## ComparaciÃ³n grÃ¡fica

```{r}
plot(K_renard, main = "K - Renard et al. 1997")
plot(K_denardin, main = "K - Denardin 1990")
plot(K_sw_SI, main = "K - Sharpley & Williams 1990")
```

## Fin del cuaderno

Este cuaderno genera tres estimaciones distintas del factor de erodabilidad K a partir de capas de SoilGrids, cada una con fundamentos empÃ­ricos validados. El usuario puede comparar los resultados y decidir cuÃ¡l utilizar en su modelo SDR o de pÃ©rdida de suelo.
